# Motion correction

The scripts within this repository utilize both two different approachs for aligning movies collected with a K2 Summit direct electron detector: 

* Whole movie frame alignment:
  * runMotionCorrection.py
     * Which runs dosefgpu_driftcorr published by [Li et al. 2013]  (http://www.ncbi.nlm.nih.gov/pubmed/23644547) 

* Per-particle alignment: 
  * runLMBFGS_relion.py
     * Which runs alignparts_lmbfgs.exe published by [Rubinstein & Brubaker 2015] (http://arxiv.org/abs/1409.6789)

__Table of contents:__

1. [Software dependencies] (https://github.com/leschzinerlab/Motion-correction#software-dependencies) 
2. [Whole frame alignment using runMotionCorrection.py] (https://github.com/leschzinerlab/Motion-correction#whole-frame-alignment-using-runmotioncorrectionpy) 
3. [Per-particle alignment using runLMBFGS_relion.py] (https://github.com/leschzinerlab/Motion-correction#per-particle-alignment-using-runlmbfgs_relionpy)

## Software dependencies

#### runMotionCorrection.py (dosefgpu_motioncorr)

You must have a GPU processor installed on your workstation with at least 4 GB of GPU memory (e.g. NVIDIA Tesla K10).

CUDA-5.0 libraries must be installed on the GPU and be placed into your path before you can execute this program:

<pre>PATH: /usr/local/cuda-5.0/bin
LD_LIBRARY_PATH: /usr/local/cuda-5.0/lib64</pre>

#### runLMBFGS_relion.py (alignparts_lmbfgs.exe)

Within this repository we are including a pre-compiled alignparts_lmbfgs.exe program that was compiled on CentOS 7. To learn more about downloading the fortan source code and compiling, check out: 

[Rubinstein Lab Google Sites Scripts Repository] (https://sites.google.com/site/rubinsteingroup/direct-detector-align_lmbfgs)

## Whole frame alignment using runMotionCorrection.py

### Inputs

As the program is currently written, it will normalize and align UN-normalized movies that were collected using Leginon. This means that it expects the following inputs: 

* Movies with the extension '.frames.mrcs'
* Gain reference '.mrc' file that has the same dimensions as the movies

### Running the program

<pre>$  Motion-correction/runMotionCorr.py 
Usage: runMotionCorr.py --dir=<folder with mrc frames> --gain_ref=<gain reference in mrc format with full path;input the *_norm* file from the leginon reference directory> --save_bin <save binned mic> --save_norm <save normalized frames>

This program takes movies with .frames.mrcs extensions and creates aligned movies with .mrc extension, along with the option to create normalized movies with the .mrcs extension.

Options:
  -h, --help       show this help message and exit
  --dir=FILE       Directory containing direct detector movies (.frames.mrcs
                   extension)
  --gain_ref=FILE  Gain reference file from Leginon with the full path (.mrc)
  --save_bin       Save binned image for quick inspection
  --save_norm      Save normalized movie frames as .mrcs
  --bin=INT        Binning factor to use during movie alignment, 1 or 2.
                   (Default=1)
  -d               debug</pre>
  
Running notes: 

* To run this program, make sure that only the movies you want aligned are within a specified directory and have the '.frames.mrcs' extension.
* Specify the absolute paths to the directory with movies and to the gain reference .mrc file

Example command: 

<pre>$ Motion-correction/runMotionCorr.py --dir=/data/frames/leginon/15sep30a/rawdata/ --gain_ref=/data/frames/leginon/15sep30a_ref/rawdata/15sep30a_31115207_07_7676x7420_norm_1.mrc --bin=2</pre>

### Outputs

The program will then align each movie using its GPU cores to produce files with the extension '.mrc'. 

For example, if you had the input micrograph: 

<pre>/data/frames/leginon/15sep30a/rawdata/15sep30a_b1_1e_00009gr_00003sq_00007hl_00001en.frames.mrcs</pre>

You would get: 

<pre>/data/frames/leginon/15sep30a/rawdata/15sep30a_b1_1e_00009gr_00003sq_00007hl_00001en.mrc</pre>

And, if you asked for normalized movie frames as an output with the <pre>--save_norm</pre> option,  you would also get: 

<pre>/data/frames/leginon/15sep30a/rawdata/15sep30a_b1_1e_00009gr_00003sq_00007hl_00001en.mrcs</pre>

## Per-particle alignment using runLMBFGS_relion.py

In order to use alignparts_lmbfgs.exe, there is a certain workflow that you will need to follow: 

* Align direct detector movies
* Pick particles
* Extract particles using Relion
* Run alignparts_lmbfgs.exe to track individual particle trajectories

### Inputs

The script described below assumes that you have the following set up (based upon Relion directory and file formatting):

* Micrographs/ - directory containing aligned movie frames (.mrc), normalized movies with .mrcs extension, CTF log files, and particle coordinates 
* Particles/Micrographs - directory containing extracted particles by Relion, which includes particle stacks per micrograph and associated STAR files.
* [input].star - STAR file generated by Relion during particle extraction

### Running the program

<pre>Motion-correction/runLMBFGS_relion.py 
Usage: runLMBFGS_relion.py --dir=<folder with micrographs> --bin=<binning>

Options:
  -h, --help            show this help message and exit
  --star=FILE           Relion starfile with particles. IMPORTANT: Particles
                        must be the same pixel size as the movies for this
                        program to work.
  --radius=INTEGER      Radius of particles in pixels
  --trialrun            Flag to run lm-bfgs on a single movie to check
                        particle trajectories and to show vector field plot
                        (Default=False)
  --nprocs=INTEGER      Number of CPUs for parallelization. (Default=1)
  --exepath=PATH        Optional: Path to executable files. (Default=Motion-
                        correction/lm-bfgs_v3.0/)
  --movieNAME=Movie extension
                        Optional: Additional name for movies.
                        (Default=.frames)
  --movieEXT=Movie extension
                        Optional: Movie extension. (Default=mrcs)
  --firstFrame=INTEGER  Optional: First frame of movies to use for alignment.
                        (Default=1)
  --lastFrame=INTEGER   Optional: Last frame of movies to use for alignment.
                        (Default=Last Frame)
  --smoothening=STRING  Optional: Amount of smoothening forced onto
                        trajectories of particles. (Default=1.0d4)
  --exaggerate=INTEGER  Optional: Factor by which particle trajectories should
                        be exaggerated in vector file. (Default=5)
  --apix=FLOAT          Optional: Provide pixel size instead of calculating
                        from star file.
  --exposureweight      Optional: Flag to exposureweight particles based upon
                        dose. (Default=False)
  --dose=FLOAT          IF EXPOSURE WEIGHTING: Dose per frame in electrons per
                        Angstroms-squared.
  -d                    debug</pre>
  
 ___Required inputs:___  
  * --star - STAR file from Relion particle extraction
  * --radius - radius of particle in pixels
  * --trialrun - IMPORTANT: As described on [Rubinstein Lab Google site] (https://sites.google.com/site/rubinsteingroup/direct-detector-align_lmbfgs), they recommend check the smoothened trajectories to check if the program is work satisfactorily. To check this on a single micorgraph, include this flag. At the end of the particle trajectory alignment, you will be shown a plot of particle trajectories.
  
  ___Optional inputs: ___
  * --nprocs - Specify number of processors for parallelizing the particle trajectory alignment. Only works on a single machine, not a cluster (at the moment).
  * --execpath - Input absolute path to compiled program 'alignparts_lmbfgs.exe'. By default, it will look in the folder provided by this Github repo: Motion-correction/lm-bfgs_v3.0/. 
  * --movieName - Additional name for movies. This is NOT the movie file extension, just additional text that differentiates the movie (if at all) from the aligned micrograph.
  * --movieEXT - Movie file extension (e.g. .mrcs)
  * --firstFrame - First frame to use in the movie alignment
  * --lastFrame - last frame to use in alignment. By default this will be the last frame in the movie.
  * --smoothening - parameter for smoothening function. NEEDS TO BE CHANGED IF YOU WANT TO ALTER OUTPUT PARTICLE TRAJECTORIES. 
  * --exaggerate - can be changed to alter output trajectories. 
  * --apix - override pixel size calculated from STAR file
  * --exposureweight - flag to weight each frame of the movie according to the dose-dependent decay of resolution information 
  * --dose - if exposure weighting, include the dose on each frame of the movie in electrons per Angstroms-squared per frame.
 
Example command: 

<pre>Motion-correction/runLMBFGS_relion.py --star=particles.star --radius=50 --nprocs=4</pre>

### Outputs

The program will provide the following outputs: 

* [input]_lmbfgs.star - output star file containing paths to the particles aligned per trajectory
* Particles/Micrographs/[file name]_lmbfgs.mrcs - particle stack for aligned particles
* Particles/Micrographs/[file name]_lmbfgs.vec - vector file to plot per particle trajectories 
